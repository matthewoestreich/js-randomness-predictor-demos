<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Emscripten App from Blob</title>
    <style>
      /* A simple visual feedback element to show when the app is running */
      #output {
        border: 1px solid #ccc;
        padding: 10px;
        height: 200px;
        overflow: auto;
        white-space: pre;
        background: #f4f4f4;
      }
    </style>
  </head>
  <body>
    <h1>Loading an Emscripten Module from a Blob</h1>
    <p>This demonstrates loading a multithreaded Emscripten application from dynamically fetched files.</p>
    <div id="output">Loading...</div>

    <script>
      // Use a self-executing async function to handle the promises from fetch
      (async () => {
        let mainScriptUrlOrBlob;

        try {
          // Step 1: Fetch the main JavaScript file and the WebAssembly binary
          const [jsResponse, wasmResponse] = await Promise.all([
            fetch("https://z3-tawny.vercel.app/emscripten-poc-built.js"),
            fetch("https://z3-tawny.vercel.app/emscripten-poc-built.wasm"),
          ]);

          console.log({ step: "1. fetch stuff", jsResponse, wasmResponse });

          if (!jsResponse.ok || !wasmResponse.ok) {
            throw new Error("Failed to fetch Emscripten files.");
          }

          // Step 2: Get the script text and create a blob URL
          const jsText = await jsResponse.text();
          const jsBlob = new Blob([jsText], { type: "text/javascript" });
          mainScriptUrlOrBlob = URL.createObjectURL(jsBlob);

          console.log({ step: "2. set mainScriptUrlOrBlob", jsText, jsBlob });
          console.log({ step: "3. Define Module" });

          // Step 3: Define the Module object with mainScriptUrlOrBlob
          var Module = {
            // Set the location of the WASM file for loading
            locateFile: (path, prefix) => {
              console.log({ step: "locateFile", path, prefix });
              if (path.endsWith(".wasm")) {
                //const returning = "emscripten-poc-built.wasm";
                const returning = "https://z3-tawny.vercel.app/emscripten-poc-built.wasm";
                return returning;
              }
              return prefix + path;
            },
            mainScriptUrlOrBlob: mainScriptUrlOrBlob,
            print: (text) => {
              const outputDiv = document.getElementById("output");
              outputDiv.textContent += text + "\n";
            },
            printErr: (text) => {
              console.error(text);
            },
            onRuntimeInitialized: () => {
              // Optional: Clean up the blob URL after the runtime has started
              // For a multithreaded app, it's safer to leave this until the app exits
              console.log("Emscripten runtime initialized.");
              // URL.revokeObjectURL(mainScriptUrlOrBlob);
            },
          };

          window._Module = Module;

          console.log({ step: "4. Module now defined, adding local script tag", Module });

          // Step 4: Create a script tag and append it to the body to execute the code
          const script = document.createElement("script");
          script.src = mainScriptUrlOrBlob;
          document.body.appendChild(script);

          const loadEmscriptenPOCScript = document.createElement("script");
          loadEmscriptenPOCScript.textContent = `
            let e = undefined;
            callPOC();

            function callPOC() {
              try {
                console.log("callPOC");
                if (emscriptenPOC != undefined) {
                  e = emscriptenPOC;
                }
                if (!e || e == undefined) {
                  console.log("e not found");
                  setTimeout(() => callPOC(), 1000);
                } else {
                  e = emscriptenPOC;
                  e(Module).then((moduleInstance) => console.log("emscriptenPOC() has been called!", { moduleInstance }));
                }
              } catch (err) {
                if (!e || e == undefined) {
                  console.log("e not found");
                  setTimeout(() => callPOC(), 1000);
                } else {
                  e = emscriptenPOC;
                  e(Module).then((moduleInstance) => console.log("emscriptenPOC() has been called!", { moduleInstance }));
                }
              }
            }
          `;
          document.body.appendChild(loadEmscriptenPOCScript);

          // For pthreads, the main thread's script URL is not used by workers.
          // However, the Module.mainScriptUrlOrBlob needs to be a URL, not a Blob,
          // for the workers to be able to use fetch() against it.
        } catch (error) {
          console.error("An error occurred during Emscripten loading:", error);
          const outputDiv = document.getElementById("output");
          outputDiv.textContent = `Error: ${error.message}`;
        }

        // Step 5: Clean up the Blob URL
        // It's best to revoke the URL only after the application and all its workers
        // have completed, to avoid race conditions.
        // For this example, we'll keep it simple and assume the app is short-lived.
        ////setTimeout(() => {
        ////  if (mainScriptUrlOrBlob) {
        ////    URL.revokeObjectURL(mainScriptUrlOrBlob);
        ////    console.log("Blob URL revoked.");
        ////  }
        ////}, 5000);
      })();
    </script>
  </body>
</html>
